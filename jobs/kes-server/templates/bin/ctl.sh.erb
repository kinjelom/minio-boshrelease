#!/bin/bash

set -e

JOB_DIR=/var/vcap/jobs/kes-server
RUN_DIR=/var/vcap/sys/run/kes-server
LOG_DIR=/var/vcap/sys/log/kes-server
PIDFILE=${RUN_DIR}/pid
BIN_PATH=/var/vcap/packages/kes

mkdir -p ${RUN_DIR} ${LOG_DIR}
chown -R vcap:vcap $RUN_DIR $LOG_DIR


case $1 in

start)

  echo $$ > $PIDFILE
  exec ${BIN_PATH}/kes server --addr '<%= p("address") %>:<%= p("port") %>' --config "$JOB_DIR/config/server-config.yaml" 1>>"${LOG_DIR}/kes-server.stdout.log"  2>>"${LOG_DIR}/kes-server.stderr.log"

;;

stop)
  killall -9 kes
  rm -f $PIDFILE

;;

*)
  echo "Usage: ctl {start|stop}" ;;

esac
