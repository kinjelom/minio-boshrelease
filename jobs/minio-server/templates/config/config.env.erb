###
# MinIO configuration file - https://min.io/docs/minio/linux/reference/minio-server/minio-server.html
# line format: ENV_NAME=value
###
<%
  # Initialize server_config with default values or an empty hash if not provided
  config = p('server_config', {})

  # Check if apply_provided_local_kes_config is true and kes-server link is available
  apply_provided_local_kes_config = p('apply_provided_local_kes_config', false)
  default_kes_config = {}

  # Only proceed if apply_provided_local_kes_config is true
  if apply_provided_local_kes_config
    if_link('kes-tls-config') do |kes_link|
      # Construct the default KES configuration using the kes_link properties
      default_kes_config = {
        'MINIO_KMS_KES_ENDPOINT' => "https://localhost:#{kes_link.p('port')}",
        'MINIO_KMS_KES_CAPATH' => '/var/vcap/jobs/minio-server/config/certs/kes/kes-server-ca.crt',
        'MINIO_KMS_KES_KEY_FILE' => '/var/vcap/jobs/minio-server/config/certs/kes/kes-client-admin.key',
        'MINIO_KMS_KES_CERT_FILE' => '/var/vcap/jobs/minio-server/config/certs/kes/kes-client-admin.crt',
        'MINIO_KMS_KES_KEY_NAME' => 'MINIO_KMS_KES_DEFAULT_KEY',
      }
    end
  end

  # Merge the default KES configuration with the server_config, giving precedence to server_config
  config = default_kes_config.merge(config)

  # Iterate over the configuration keys and values, outputting them
  config.each do |key, value|
%><%= key %>=<%= value %>
<% end %>
